!function(){"use strict";const e="https://apps.panlex.org/do_the_five-server",t=window.top,n=[...document.querySelectorAll("[contenteditable='true']")],o=new URLSearchParams(t.location.search),r=null!==o.get("official"),a=o.get("uid")||"eng-000",i=o.get("id")||"";let l={};const c={},s=new Error("borked-error"),d=new Error("frozen-uid-error"),m=new Error("pw-empty-error"),u=new Error("panlexese-error"),p=new Error("title-error");let h;const g=t.toTarget=e=>{const n=t.scrollY,o=new URL(t.location);o.hash=e||"",e||(o.href+="#"),t.location.replace(o),o.hash="",t.history.replaceState(null,"",o),t.scrollY!==n&&t.scroll({left:t.scollX,top:n,behavior:"auto"}),h=e},f=e=>{27===e.keyCode&&h&&g()},y=e=>e.replace(/[&<>]/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[e]||e)),w=e=>{n.forEach(t=>{var n,o;t.innerHTML=(n=e[t.id],o="stop"===t.id,Array.isArray(n)?n.map(([e,t])=>`<span class="panlexese pl${t}">${y(o?e.toUpperCase():e)}</span>`).join(" — "):y(n)),r&&Array.isArray(e[t.id])&&(c[t.id]=t.textContent,t.classList.add("highlight-dark"),t.addEventListener("input",e=>t.classList.remove("highlight-dark"),{once:!0}))}),document.title=document.getElementById("stop").textContent},E=e=>{n.forEach(t=>{var n,o;("SPAN"===t.tagName?t.parentNode:t).setAttribute("title",(n=e[t.id],o="stop"===t.id,Array.isArray(n)?n.map(([e,t])=>o?e.toUpperCase():e).join(" — "):n))})},v=t=>{const n=new URL(e+"/");return t.filter((e,n)=>t.indexOf(e)===n).forEach(e=>e&&n.searchParams.append("uid",e)),n},C=e=>{const n=new URL(t.location);n.searchParams.set("uid",e.target.dataset.uid),n.searchParams.delete("id"),r&&n.searchParams.set("official",""),t.location=n},R=()=>new Promise((o,i)=>{(()=>{if(!r)return Promise.reject(s);const o={err:null,highlight:null},i=Array.from(n).reduce((e,t)=>({...e,[t.id]:t.textContent}),{}),h=new URLSearchParams;h.append("uid",a);for(const e in i)e in c&&c[e]===i[e]||h.append(e,i[e]);if(h.append("email",document.getElementById("email-input").value.trim()),h.append("name",document.getElementById("name-input").value.trim()),i.stop===c.stop&&(o.err=p,o.highlight="stop"),Object.keys(i).some(e=>i[e].match(/—| - /)&&!("stop"===e&&i.stop===c.stop))&&(o.err=u,o.highlight=null),r)if(l.official_frozen)o.err=d;else{const e=document.getElementById("official-pw").value.trim().toLowerCase();e.length?h.append("official",e):o.err||(o.err=m,o.highlight="official-pw")}return fetch(e+"/add",{method:"POST",body:h}).then(e=>e.json()).then(e=>(o.url=new URL(t.location),o.url.searchParams.set("uid",a),o))})().then(e=>{o(e.url)},()=>{const e=new URL(t.location);e.searchParams.has("uid")||e.searchParams.set("uid",a),o(e)})}),b=e=>{e.searchParams.delete("official"),e.searchParams.delete("edit")},I={facebook:(e,t)=>"https://facebook.com/sharer/sharer.php?u="+encodeURIComponent(t),twitter:(e,t)=>`https://twitter.com/intent/tweet/?text=${encodeURIComponent(e)}&url=${encodeURIComponent(t)}`,whatsapp:(e,t)=>"whatsapp://send?text="+encodeURIComponent(e+" "+t),vk:(e,t)=>`http://vk.com/share.php?title=${encodeURIComponent(e)}&url=${encodeURIComponent(t)}`,telegram:(e,t)=>`https://telegram.me/share/url?text=${encodeURIComponent(e)}&url=${encodeURIComponent(t)}`,weibo:(e,t)=>`http://service.weibo.com/share/share.php?title=${encodeURIComponent(e)}&url=${encodeURIComponent(t)}`,qq:(e,t)=>`http://connect.qq.com/widget/shareqq/index.html?title=${encodeURIComponent(e)}&url=${encodeURIComponent(t)}`,email:(e,t)=>`mailto:?subject=${encodeURIComponent(e)}&body=${encodeURIComponent(t)}`,weixin:(e,t)=>"",linkedin:(e,t)=>`https://www.linkedin.com/shareArticle?mini=true&url=${encodeURIComponent(t)}&title=${encodeURIComponent(e)}`},x=new QRCode(document.getElementById("qrcode"),{width:500,height:500}),L=e=>{const t=e.currentTarget.id;R().then(e=>{b(e),U(e,t)}),e.preventDefault()},U=(e,t)=>{"weixin"===t?(x.makeCode(e.toString()),g("qrcode-popup")):(g(),window.open(I[t](document.getElementById("stop").textContent,e),"_blank","noopener"))};let k,A=0;const B=document.getElementById("poster").getBoundingClientRect().width,P=()=>{const e=document.getElementById("container"),n=.95*t.document.documentElement.clientWidth/B;e.style.transform=n<1?`scale(${n})`:null;const o=Number(e.getBoundingClientRect().height);if(document.body.style.height=o+"px",k){k.style.height=o+40+"px";const e=k.getBoundingClientRect().left;0!==e&&(A-=e,k.style.left=A+"px")}},$=()=>{if(window!==t&&S(),window.addEventListener("keydown",f),t.addEventListener("resize",P),P(),(()=>{if("eng-000"!==a){const e=v(["eng-000","eng-000"]);return fetch(e).then(e=>e.json()).then(e=>{E(e)})}Promise.resolve()})(),[...t.document.getElementsByClassName("app")].forEach(e=>{const n=new URL(t.location);b(n),e.href=I[e.id](document.getElementById("stop").textContent,n),e.addEventListener("click",L)}),navigator.maxTouchPoints&&navigator.share){const e=document.getElementById("share-button");e.removeAttribute("onclick"),e.addEventListener("click",()=>navigator.share({url:t.location.href}))}o.has("print")&&document.documentElement.classList.add("fullsize"),o.has("png")&&document.documentElement.classList.add("png"),r||[...document.getElementsByClassName("official-only")].forEach(e=>e.style.display="none"),r?n.forEach(e=>{e.addEventListener("paste",t=>{window.setTimeout(()=>{const t=window.getSelection();t.isCollapsed||t.collapseToEnd();let n=t.focusNode,o=1!==n.nodeType||n.textContent.length?t.focusOffset:0;for(;"true"!==n.contentEditable;){let e=n.previousSibling;for(;e;)o+=e.textContent.length,e=e.previousSibling;n=n.parentNode}e.textContent=e.textContent.replace(/\u00A0/g," "),o>e.textContent.length&&(o=e.textContent.length);const r=document.createRange();r.setStart(e.firstChild,o),r.setEnd(e.firstChild,o),t.removeAllRanges(),t.addRange(r)},0)})}):(n.forEach(e=>e.contentEditable=!1),document.getElementById("bottom-form").style.display="none")},S=()=>{k=t.document.querySelector("iframe"),t.addEventListener("keydown",f),document.querySelectorAll('link[rel="stylesheet"]').forEach(e=>{(e=e.cloneNode()).setAttribute("href",e.href),t.document.head.appendChild(e)});const e=t.document.createElement("div");e.id="do_the_five",document.querySelectorAll(".overlay").forEach(t=>{e.appendChild(t)}),t.document.body.appendChild(e);const n=t.document.querySelector("meta[name='viewport']");n&&n.getAttribute("content").match(/maximum-scale/)&&n.replaceWith(document.querySelector("meta[name='viewport']").cloneNode())};fetch(`${e}/langvar/${a}`).then(e=>e.json()).then(e=>{l=e,document.documentElement.setAttribute("lang","und-"+l.script_expr_txt),document.documentElement.setAttribute("dir",l.dir);const t=document.getElementById("lang-picker");return t.value=l.name_expr_txt,t.addEventListener("language-select",C),t.addEventListener("focus",e=>e.currentTarget.value=""),document.getElementById("lang-picker-form").addEventListener("submit",e=>{e.preventDefault();const t=e.target.querySelector("li");t&&t.click()}),(()=>{const e=v([a,"eng-000","eng-000"]);return i&&e.searchParams.append("id",i),fetch(e).then(e=>e.json()).then(e=>{w(e)})})()}).finally(()=>{if($(),document.body.style.visibility="visible",o.has("success")){const e=new URL(t.location);e.searchParams.delete("success"),t.history.replaceState(null,"",e),setTimeout(()=>{return e="success-alert",t.document.getElementById("alert").innerHTML=document.getElementById(e).innerHTML,void g("alert-popup");var e},200)}})}();
